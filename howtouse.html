<html>
<head>
	<meta charset="utf-8"/>
	<link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link href="./nes.min.css" rel="stylesheet" />
	<style>
		html, body, pre, code, kbd, samp {
			font-family:"Press Start 2P";
		}

		body{
			margin:1%;
			border:0;
			background-image: linear-gradient(to left top, #e1c5d5, #ddc5da, #d8c6e0, #d1c7e5, #c8c9e9, #c1cded, #bad2f0, #b4d6f2, #b1ddf3, #b1e4f3, #b4eaf0, #bbf0ed);
			width:100%;
			height:100%;
			overflow:hidden;
		} 

		button {
			margin:10px 3px;
		}

		button, input, optgroup, select, textarea {
			font-family: inherit;
			font-size: inherit;
			line-height: inherit;
			padding: 8px 12px;
		}
		
		button:active{
			background-color:#BBB;
		}

	</style>
</head>
<body>
<script>
function generateStreamID(){
	var text = "";
	var possible = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";
	for (var i = 0; i < 10; i++){
		text += possible.charAt(Math.floor(Math.random() * possible.length));
	}
	return text;
};

(function (w) {
	w.URLSearchParams = w.URLSearchParams || function (searchString) {
		var self = this;
		self.searchString = searchString;
		self.get = function (name) {
			var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(self.searchString);
			if (results == null) {
				return null;
			}
			else {
				return decodeURI(results[1]) || 0;
			}
		};
	};

})(window);

var urlParams = new URLSearchParams(window.location.search);

window.onerror = function backupErr(errorMsg, url=false, lineNumber=false) {
	console.error(errorMsg);
	console.error(lineNumber);
	console.error("Unhandeled Error occured"); //or any message
	return false;
};

window.onbeforeunload = function() {
	return "Dude, are you sure you want to leave? Think of the kittens!"; // prevents accidental page reloads.
}
	
var WID = "testOBSN";
if (urlParams.has("osc")){
	WID = urlParams.get("osc");
} else if (urlParams.has("id")){
	WID = urlParams.get("id");
} else if (urlParams.has("ID")){
	WID = urlParams.get("ID");
} else if (urlParams.has("wid")){
	WID = urlParams.get("wid");
} else {
	WID = generateStreamID(10);
}

var path = window.location.host+window.location.pathname.split("/").slice(0,-1).join("/");

document.body.innerHTML += "Your OSC.Ninja Link: <a href='https://"+path+"/?osc="+WID+"' target='_blank'>https://"+path+"/?osc="+WID+"</a><br /><br />";
document.body.innerHTML += "<small>You can append your own VDO.Ninja parameters to this link, treating it like a normal VDO.Ninja link.";
document.body.innerHTML += "<br /><br />Code hosted at <a href='https://github.com/steveseguin/osc.ninja'>https://github.com/steveseguin/osc.ninja <svg width='32' height='32' viewBox='0 0 1024 1024' fill='none' xmlns='http://www.w3.org/2000/svg'><path fill-rule='evenodd' clip-rule='evenodd' d='M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z' transform='scale(64)' fill='#1B1F23'/></svg></a></small>";

var counter=0;
var idle = null;

var socket = new WebSocket("wss://companion.vdo.ninja:443");
	
socket.onclose = function (){
	socket = new WebSocket("wss://companion.vdo.ninja:443");
};

socket.onerror = function (){
	setTimeout(function(){
		socket = new WebSocket("wss://companion.vdo.ninja:443");
	},1000);
};

socket.onopen = function (){
	socket.send(JSON.stringify({"join":WID}));
	actions = loadIframeCommands();
}

socket.addEventListener('message', function (event) {
	if (event.data){
		var data = JSON.parse(event.data);
		log(data);
		if ("id" in data){
			if (data.id>counter){
			counter=data.id;
			} else {
				return; // obsolete.
			}
		}
		
		if ("action" in data){
			if (data.action in actions){
				if ("value" in data){
					actions[data.action](data.value);
				} else {
					actions[data.action]();
				}
			}
		}
		
	}
});


function log(msg){
	console.log(msg);
}

function ajax(data) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      log("GOOD");
    }
  };
  var action = false
  if ("action" in data){
	action=data['action'];
  }
  var value = "null"
  if ("value" in data){
	value=data['value'];
  }
  var room = false
  if ("room" in data){
	room=data['room'];
  }
  var target = "null";
  if ("target" in data){
	target=data['target'];
  }
  
  if (!action || !room){
	alert("no action or room provided; request won't work");
  } else {
	var URL = "https://companion.vdo.ninja/"+room+"/"+action+"/"+target+"/"+value;
	xhttp.open("GET", URL, true);
	xhttp.send();
  }
}

function loadIframeCommands(){
	var commands = {}
	commands.mute = function(value){socket.send(JSON.stringify({"msg":{"action":"mute","value":value}}))};  // "speaker" also works in the same way
	
	commands.mic = function(value){socket.send(JSON.stringify({"msg":{"action":"mic","value":value}}))};

	commands.camera = function(value){socket.send(JSON.stringify({"msg":{"action":"camera","value":value}}))};

	commands.bitrate = function(value){socket.send(JSON.stringify({"msg":{"action":"bitrate","value":value}}))};

	commands.volume = function(value){socket.send(JSON.stringify({"msg":{"action":"volume","value":value}}))};

	commands.record = function(value){socket.send(JSON.stringify({"msg":{"action":"record","value":value}}))};

	commands.sendChat = function(value){socket.send(JSON.stringify({"msg":{"action":"sendChat","value":value}}))};
	
	setTimeout(function(){
		var hr = document.createElement("hr");
		document.body.appendChild(hr);
		var h3 = document.createElement("h3");
		h3.innerText = "These are Websocket-based requests";
		document.body.appendChild(h3);
	},0);

	for (var k in commands) {
		setTimeout(function(k){
			var button = document.createElement("button");
			button.innerHTML = k + ":<br />TRUE"; 
			button.onclick = function(){commands[k](true);}
			document.body.appendChild(button);
		},0,k);
		
		setTimeout(function(k){
			var button = document.createElement("button");
			button.innerHTML = k + ":<br />FALSE"; 
			button.onclick = function(){commands[k](false);}
			document.body.appendChild(button);
		},0,k);
		log(k);
	} // list available commands to console
	
	commands.reload = function(){socket.send(JSON.stringify({"msg":{"action":"reload","value":true}}))};
	
	commands.close = function(){socket.send(JSON.stringify({"msg":{"action":"close","value":true}}))};
	
	k = "reload";
	setTimeout(function(k){
		var button = document.createElement("button");
		button.innerHTML = k + ":<br />TRUE"; 
		button.onclick = function(){commands[k](true);}
		document.body.appendChild(button);
	},0,k);
	
	k = "close";
	setTimeout(function(k){
		var button = document.createElement("button");
		button.innerHTML = k + ":<br />TRUE"; 
		button.onclick = function(){commands[k](true);}
		document.body.appendChild(button);
	},0,k);
	
	
	var commands2 = {}
	commands2.mute = function(value){ajax({"action":"mute","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.mic = function(value){ajax({"action":"mic","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.camera = function(value){ajax({"action":"camera","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.bitrate = function(value){ajax({"action":"bitrate","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.volume = function(value){ajax({"action":"volume","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.record = function(value){ajax({"action":"record","value":value,"room":WID})};  // "speaker" also works in the same way
	
	setTimeout(function(){
		var hr = document.createElement("hr");
		document.body.appendChild(hr);
		var h3 = document.createElement("h3");
		h3.innerText = "These are HTTP-based GET requests";
		document.body.appendChild(h3);
	},0);
	
	for (var k in commands2) {
	
		setTimeout(function(k){
			var button = document.createElement("button");
			button.innerHTML = k + ":<br />TRUE"; 
			button.onclick = function(){commands2[k](true);}
			document.body.appendChild(button);
		},0,k);
		
		setTimeout(function(k){
			var button = document.createElement("button");
			button.innerHTML = k + ":<br />FALSE"; 
			button.onclick = function(){commands2[k](false);}
			document.body.appendChild(button);
		},0,k);
		log(k);
	} 
	
	
		
}



</script>
</body>
</html>










