<html>
<head>
	<meta charset="utf-8"/>
	<link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link href="./nes.min.css" rel="stylesheet" />
	<style>
		html, body, pre, code, kbd, samp {
			font-family:"Press Start 2P";
		}

		body{
			margin:1%;
			border:0;
			background-image: linear-gradient(to left top, #e1c5d5, #ddc5da, #d8c6e0, #d1c7e5, #c8c9e9, #c1cded, #bad2f0, #b4d6f2, #b1ddf3, #b1e4f3, #b4eaf0, #bbf0ed);
			width:100%;
			height:100%;
			overflow:hidden;
		} 

		button {
			margin:10px 3px;
		}

		button, input, optgroup, select, textarea {
			font-family: inherit;
			font-size: inherit;
			line-height: inherit;
			padding: 8px 12px;
		}
		
		button:active{
			background-color:#BBB;
		}

	</style>
</head>
<body>
<script>
function generateStreamID(){
	var text = "";
	var possible = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";
	for (var i = 0; i < 10; i++){
		text += possible.charAt(Math.floor(Math.random() * possible.length));
	}
	return text;
};

(function (w) {
	w.URLSearchParams = w.URLSearchParams || function (searchString) {
		var self = this;
		self.searchString = searchString;
		self.get = function (name) {
			var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(self.searchString);
			if (results == null) {
				return null;
			}
			else {
				return decodeURI(results[1]) || 0;
			}
		};
	};

})(window);

var urlParams = new URLSearchParams(window.location.search);

window.onerror = function backupErr(errorMsg, url=false, lineNumber=false) {
	console.error(errorMsg);
	console.error(lineNumber);
	console.error("Unhandeled Error occured"); //or any message
	return false;
};

window.onbeforeunload = function() {
	return "Dude, are you sure you want to leave? Think of the kittens!"; // prevents accidental page reloads.
}
	
var WID = "testOBSN";
if (urlParams.has("osc")){
	WID = urlParams.get("osc");
} else if (urlParams.has("id")){
	WID = urlParams.get("id");
} else if (urlParams.has("ID")){
	WID = urlParams.get("ID");
} else if (urlParams.has("wid")){
	WID = urlParams.get("wid");
} else {
	WID = generateStreamID(10);
}

var path = window.location.host+window.location.pathname.split("/").slice(0,-1).join("/");

document.body.innerHTML += "Your OSC.Ninja Link: <a href='https://"+path+"/?osc="+WID+"' target='_blank'>https://"+path+"/?osc="+WID+"</a><br /><br />";
document.body.innerHTML += "<small>You can append your own VDO.Ninja parameters to this link, treating it like a normal VDO.Ninja link.</small>";
document.body.innerHTML += '<br /><br />Code hosted at <a href="https://github.com/steveseguin/osc.ninja
">https://github.com/steveseguin/osc.ninja <img src="data:image/png;base64,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" /></a>';

var counter=0;
var idle = null;

var socket = new WebSocket("wss://companion.vdo.ninja:443");
	
socket.onclose = function (){
	socket = new WebSocket("wss://companion.vdo.ninja:443");
};

socket.onerror = function (){
	setTimeout(function(){
		socket = new WebSocket("wss://companion.vdo.ninja:443");
	},1000);
};

socket.onopen = function (){
	socket.send(JSON.stringify({"join":WID}));
	actions = loadIframeCommands();
}

socket.addEventListener('message', function (event) {
	if (event.data){
		var data = JSON.parse(event.data);
		log(data);
		if ("id" in data){
			if (data.id>counter){
			counter=data.id;
			} else {
				return; // obsolete.
			}
		}
		
		if ("action" in data){
			if (data.action in actions){
				if ("value" in data){
					actions[data.action](data.value);
				} else {
					actions[data.action]();
				}
			}
		}
		
	}
});


function log(msg){
	console.log(msg);
}

function ajax(data) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      log("GOOD");
    }
  };
  var action = false
  if ("action" in data){
	action=data['action'];
  }
  var value = "null"
  if ("value" in data){
	value=data['value'];
  }
  var room = false
  if ("room" in data){
	room=data['room'];
  }
  var target = "null";
  if ("target" in data){
	target=data['target'];
  }
  
  if (!action || !room){
	alert("no action or room provided; request won't work");
  } else {
	var URL = "https://companion.vdo.ninja/"+room+"/"+action+"/"+target+"/"+value;
	xhttp.open("GET", URL, true);
	xhttp.send();
  }
}

function loadIframeCommands(){
	var commands = {}
	commands.mute = function(value){socket.send(JSON.stringify({"msg":{"action":"mute","value":value}}))};  // "speaker" also works in the same way
	
	commands.mic = function(value){socket.send(JSON.stringify({"msg":{"action":"mic","value":value}}))};

	commands.camera = function(value){socket.send(JSON.stringify({"msg":{"action":"camera","value":value}}))};

	commands.bitrate = function(value){socket.send(JSON.stringify({"msg":{"action":"bitrate","value":value}}))};

	commands.volume = function(value){socket.send(JSON.stringify({"msg":{"action":"volume","value":value}}))};

	commands.record = function(value){socket.send(JSON.stringify({"msg":{"action":"record","value":value}}))};

	commands.sendChat = function(value){socket.send(JSON.stringify({"msg":{"action":"sendChat","value":value}}))};
	
	setTimeout(function(){
		var hr = document.createElement("hr");
		document.body.appendChild(hr);
		var h3 = document.createElement("h3");
		h3.innerText = "These are Websocket-based requests";
		document.body.appendChild(h3);
	},0);

	for (var k in commands) {
		setTimeout(function(k){
			var button = document.createElement("button");
			button.innerHTML = k + ":<br />TRUE"; 
			button.onclick = function(){commands[k](true);}
			document.body.appendChild(button);
		},0,k);
		
		setTimeout(function(k){
			var button = document.createElement("button");
			button.innerHTML = k + ":<br />FALSE"; 
			button.onclick = function(){commands[k](false);}
			document.body.appendChild(button);
		},0,k);
		log(k);
	} // list available commands to console
	
	commands.reload = function(){socket.send(JSON.stringify({"msg":{"action":"reload","value":true}}))};
	
	commands.close = function(){socket.send(JSON.stringify({"msg":{"action":"close","value":true}}))};
	
	k = "reload";
	setTimeout(function(k){
		var button = document.createElement("button");
		button.innerHTML = k + ":<br />TRUE"; 
		button.onclick = function(){commands[k](true);}
		document.body.appendChild(button);
	},0,k);
	
	k = "close";
	setTimeout(function(k){
		var button = document.createElement("button");
		button.innerHTML = k + ":<br />TRUE"; 
		button.onclick = function(){commands[k](true);}
		document.body.appendChild(button);
	},0,k);
	
	
	var commands2 = {}
	commands2.mute = function(value){ajax({"action":"mute","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.mic = function(value){ajax({"action":"mic","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.camera = function(value){ajax({"action":"camera","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.bitrate = function(value){ajax({"action":"bitrate","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.volume = function(value){ajax({"action":"volume","value":value,"room":WID})};  // "speaker" also works in the same way
	commands2.record = function(value){ajax({"action":"record","value":value,"room":WID})};  // "speaker" also works in the same way
	
	setTimeout(function(){
		var hr = document.createElement("hr");
		document.body.appendChild(hr);
		var h3 = document.createElement("h3");
		h3.innerText = "These are HTTP-based GET requests";
		document.body.appendChild(h3);
	},0);
	
	for (var k in commands2) {
	
		setTimeout(function(k){
			var button = document.createElement("button");
			button.innerHTML = k + ":<br />TRUE"; 
			button.onclick = function(){commands2[k](true);}
			document.body.appendChild(button);
		},0,k);
		
		setTimeout(function(k){
			var button = document.createElement("button");
			button.innerHTML = k + ":<br />FALSE"; 
			button.onclick = function(){commands2[k](false);}
			document.body.appendChild(button);
		},0,k);
		log(k);
	} 
	
	
		
}



</script>
</body>
</html>










